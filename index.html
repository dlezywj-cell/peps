<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼°å€¼é€è§† (æœ€ç»ˆå®Œç¾ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #2980b9; --danger: #c0392b; --bg: #f5f7fa; --text: #2c3e50; --border: #e0e0e0; }
        body { margin: 0; padding: 15px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; }
        
        .container { 
            width: 100%; max-width: 1200px; background: #fff; 
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header */
        header { 
            padding: 12px 20px; border-bottom: 1px solid var(--border); background: #fff; 
            display: flex; align-items: center; justify-content: space-between; height: 40px; 
        }
        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; overflow: hidden; }
        h2 { margin: 0; font-size: 16px; font-weight: 700; white-space: nowrap; display: flex; align-items: center; gap: 6px; color: #333; }

        /* Controls */
        .controls { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; }
        .search-group { display: flex; align-items: center; gap: 0; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        #stockInput { border: none; padding: 6px 8px; font-size: 13px; width: 100px; outline: none; font-weight: 600; }
        #btnSearch { border: none; background: var(--primary); color: #fff; padding: 0 10px; height: 28px; cursor: pointer; font-size: 12px; border-radius: 0; }
        #btnSearch:hover { opacity: 0.9; }
        .date-inp { border: 1px solid #ccc; border-radius: 4px; padding: 4px 6px; font-size: 12px; width: 110px; font-family: inherit; color: #555; }
        .action-btn { border: none; border-radius: 4px; padding: 5px 12px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; white-space: nowrap; height: 28px; }
        .btn-calc { background: #f2f2f7; color: #333; } .btn-calc:hover { background: #e5e5ea; }
        .btn-calc:disabled { color: #ccc; cursor: not-allowed; }
        .btn-reset { background: transparent; color: #666; border: 1px solid #eee; } .btn-reset:hover { border-color: #ccc; }
        .divider { width: 1px; height: 16px; background: #ddd; margin: 0 2px; }

        /* Sync Status */
        .header-right { display: flex; align-items: center; }
        .sync-badge { font-size: 12px; color: #666; display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: 0.2s; }
        .sync-badge:hover { background: #f5f5f5; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.ok { background: var(--success); box-shadow: 0 0 4px var(--success); }
        .dot.sync { background: var(--primary); animation: pulse 1s infinite; }
        .dot.err { background: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding: 0; }
            .container { border-radius: 0; min-height: 100vh; }
            header { height: auto; padding: 10px; display: block; }
            .header-left { display: block; width: 100%; }
            .header-right { position: absolute; top: 12px; right: 12px; }
            h2 { margin-bottom: 10px; }
            .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-wrap: wrap; }
            .search-group { grid-column: 1 / -1; width: 100%; }
            #stockInput { width: 100%; }
            .date-inp { width: 100%; box-sizing: border-box; }
            .divider { display: none; }
            .action-btn { justify-content: center; height: 32px; font-size: 13px; }
            .chart-wrapper { height: 350px !important; }
        }

        /* Chart & Table */
        .chart-wrapper { height: 520px; width: 100%; position: relative; }
        #chart-container { width: 100%; height: 100%; }
        .table-box { overflow-x: auto; border-top: 1px solid #eee; background: #fff; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 13px; text-align: right; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
        th { background: #f9f9fb; color: #666; font-weight: 600; position: sticky; top: 0; z-index: 20; font-size: 12px; }
        th:first-child, td:first-child { position: sticky; left: 0; background: #fff; z-index: 10; text-align: left; border-right: 1px solid #f0f0f0; box-shadow: 2px 0 5px rgba(0,0,0,0.02); font-family: "SF Mono", monospace; }
        th:first-child { z-index: 30; background: #f9f9fb; }

        .tag-real { background: #e6f7ff; color: #1890ff; padding: 1px 4px; border-radius: 3px; font-size: 10px; }
        .tag-man { background: #fff1f0; color: #ff4d4f; padding: 1px 4px; border-radius: 3px; font-size: 10px; cursor: pointer; }
        .loss { color: #27ae60; font-style: italic; }
        .val-pe { color: var(--danger); font-weight: 600; font-family: "SF Mono", monospace; }
        .val-ps { color: var(--primary); font-weight: 600; font-family: "SF Mono", monospace; }

        /* Modal & Toast */
        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 4px; font-size: 13px; z-index: 9999; display: none; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: #fff; width: 300px; border-radius: 8px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-tt { font-weight: bold; font-size: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .inp-row { margin-bottom: 10px; }
        .inp-row label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .inp-row input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn-full { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-ok { background: var(--primary); color: #fff; }
        .btn-cancel { background: #f5f5f5; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <h2>ğŸ“ˆ ä¼°å€¼é€è§†</h2>
            <div class="controls">
                <div class="search-group">
                    <input type="text" id="stockInput" value="è´µå·èŒ…å°" placeholder="ä»£ç /åç§°">
                    <button id="btnSearch"><i class="fas fa-search"></i> æœç´¢</button>
                </div>
                <div class="divider"></div>
                <input type="date" id="startDate" class="date-inp" value="2020-01-01">
                <input type="date" id="endDate" class="date-inp">
                <div class="divider"></div>
                <button class="action-btn btn-calc" id="btn-run" disabled><i class="fas fa-bolt"></i> è®¡ç®—</button>
                <button class="action-btn btn-reset" onclick="resetZoom()"><i class="fas fa-sync-alt"></i> é‡ç½®</button>
            </div>
        </div>
        <div class="header-right">
            <div class="sync-badge" onclick="showSettings()" title="GitHub é…ç½®">
                <div id="syncDot" class="dot"></div>
                <span id="syncTxt">æœªé…ç½®</span>
                <i class="fas fa-cog" style="color:#999; font-size:12px;"></i>
            </div>
        </div>
    </header>

    <div class="chart-wrapper">
        <div id="chart-container"></div>
    </div>

    <div class="table-box">
        <table id="dataTable">
            <thead>
                <tr><th>æ—¥æœŸ</th><th>è‚¡ä»·</th><th>æ¥æº</th><th>å¸‚å€¼(äº¿)</th><th>è¥æ”¶(äº¿)</th><th>å‡€åˆ©(äº¿)</th><th style="color:var(--danger)">PE</th><th style="color:var(--primary)">PS</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="toast" class="toast"></div>

<!-- å½•å…¥å¼¹çª— -->
<div id="inputModal" class="overlay">
    <div class="modal">
        <div class="modal-tt">âœï¸ å½•å…¥ <span id="modalYear"></span>å¹´ æ•°æ®</div>
        <div style="font-size:12px; color:#c0392b; background:#fff2f0; padding:8px; border-radius:4px; margin-bottom:10px;">âš ï¸ è´¢æŠ¥ç¼ºå¤±ï¼Œè¯·æ‰‹åŠ¨è¡¥å……é¢„æµ‹å€¼</div>
        <div class="inp-row"><label>é¢„æµ‹è¥ä¸šæ”¶å…¥ (äº¿)</label><input type="number" id="inRev"></div>
        <div class="inp-row"><label>é¢„æµ‹å‡€åˆ©æ¶¦ (äº¿)</label><input type="number" id="inProf"></div>
        <div class="btn-row">
            <button class="btn-full btn-cancel" onclick="closeInput(false)">å–æ¶ˆ</button>
            <button class="btn-full btn-ok" onclick="closeInput(true)">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div id="settingModal" class="overlay">
    <div class="modal">
        <div class="modal-tt">â˜ï¸ GitHub åŒæ­¥ <i class="fas fa-times" style="cursor:pointer;color:#999" onclick="closeSettings()"></i></div>
        <div class="inp-row"><label>Token (å¿…å¡«)</label><input type="password" id="cfgToken" placeholder="ghp_..."></div>
        <div class="inp-row"><label>ç”¨æˆ·å</label><input type="text" id="cfgUser" value="dlezywj-cell"></div>
        <div class="inp-row"><label>ä»“åº“å</label><input type="text" id="cfgRepo" value="pepsdata"></div>
        <div class="inp-row"><label>æ–‡ä»¶å</label><input type="text" id="cfgFile" value="data.json" disabled style="background:#f5f5f5"></div>
        <div class="btn-row"><button class="btn-full btn-ok" onclick="saveConfig()">ä¿å­˜å¹¶è¿æ¥</button></div>
    </div>
</div>

<script>
    let myChart = null;
    let currentStock = { code: '', name: '', secId: '' };
    let globalData = [];
    let currentTotalShares = 0;
    let splitIdxGlobal = -1;
    const PROXY = "https://corsproxy.io/?";
    const DB_KEY = "stock_valuation_db_v2";
    
    let ghConfig = {
        token: localStorage.getItem('gh_token') || '',
        user: localStorage.getItem('gh_user') || 'dlezywj-cell',
        repo: localStorage.getItem('gh_repo') || 'pepsdata',
        file: 'data.json'
    };

    let inputResolve = null;
    let syncTimer = null;

    document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
    myChart = echarts.init(document.getElementById('chart-container'));
    window.addEventListener('resize', () => myChart.resize());

    myChart.on('dataZoom', updateDynamicMarks);

    document.getElementById('btnSearch').addEventListener('click', runSearch);
    document.getElementById('btn-run').addEventListener('click', () => runAnalysis(false));
    document.getElementById('stockInput').addEventListener('keydown', e => { if(e.keyCode===13) runSearch(); });

    if(ghConfig.token) syncCloud(); else setStatus('ready', 'æœ¬åœ°');

    async function runSearch() {
        const val = document.getElementById('stockInput').value.trim();
        if(!val) return;
        try {
            document.getElementById('btnSearch').innerHTML = '...';
            const url = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D50F639205545E43`;
            const res = await fetch(PROXY + encodeURIComponent(url));
            const json = await res.json();
            if(json?.QuotationCodeTable?.Data?.length > 0) {
                const item = json.QuotationCodeTable.Data[0];
                currentStock = { code: item.Code, name: item.Name, secId: (item.MarketType == "1" || item.Code.startsWith('6')) ? `1.${item.Code}` : `0.${item.Code}` };
                document.getElementById('btn-run').disabled = false;
                toast(`âœ… é”å®š: ${item.Name}`);
            } else toast('âŒ æœªæ‰¾åˆ°');
        } catch(e) { toast('âŒ ç½‘ç»œé”™'); } 
        finally { document.getElementById('btnSearch').innerHTML = '<i class="fas fa-search"></i> æœç´¢'; }
    }

    async function runAnalysis(silent) {
        const btn = document.getElementById('btn-run');
        if(!silent) { btn.disabled = true; btn.innerText = '...'; }
        try {
            const beg = document.getElementById('startDate').value.replace(/-/g, '');
            const end = document.getElementById('endDate').value.replace(/-/g, '');
            const checkYear = new Date().getFullYear();

            if(!silent || !globalData.length) await Promise.all([fetchShares(), fetchKline(beg, end)]);
            let finMap = await fetchFinancials(currentStock.code);

            // --- ä¼˜å…ˆçº§: çœŸå® > å½•å…¥ ---
            const dbData = getLocal()[currentStock.code] || {};
            
            Object.keys(dbData).forEach(yStr => {
                const y = parseInt(yStr);
                const saved = dbData[y];
                // åªæœ‰å½“finMapä¸­ä¸å­˜åœ¨è¯¥å¹´ä»½(æ²¡çœŸå®è´¢æŠ¥)æ—¶ï¼Œæ‰ç”¨å½•å…¥å€¼
                if (!finMap[y] && saved) {
                    finMap[y] = { year: y, rev: saved.rev, prof: saved.prof, source: 'manual', name: `â˜…${y}å½•å…¥` };
                }
            });

            if(!finMap[checkYear] && !silent) {
                const manual = await openInput(checkYear);
                if(manual) {
                    await saveDB(currentStock.code, checkYear, manual.rev, manual.prof);
                    finMap[checkYear] = { year: checkYear, rev: manual.rev, prof: manual.prof, source: 'manual', name: `â˜…${checkYear}å½•å…¥` };
                }
            } else if (finMap[checkYear] && finMap[checkYear].source === 'manual' && !silent) {
                toast(`å·²åŠ è½½ ${checkYear} å½•å…¥æ•°æ®`);
            }

            calculate(finMap);
            renderChart();
            renderTable();
        } catch(e) { console.error(e); if(!silent) toast('è¿è¡Œå‡ºé”™'); } 
        finally { if(!silent) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-bolt"></i> è®¡ç®—'; } }
    }

    function calculate(finMap) {
        const years = Object.keys(finMap).map(Number).sort((a,b)=>a-b);
        if(!years.length) return;
        
        globalData = globalData.map(d => {
            const y = new Date(d.date).getFullYear();
            
            // ä¸¥è°¨çš„æ—¶åºåŒ¹é…ï¼šåªèƒ½å¾€å›æ‰¾ï¼Œä¸èƒ½ç©¿è¶Šæœªæ¥
            const availYears = years.filter(year => year <= y);
            const targetYear = availYears.length > 0 ? availYears[availYears.length-1] : years[0];
            
            let fin = finMap[targetYear];
            
            if(fin) {
                const mk = d.price * currentTotalShares;
                return { 
                    ...d, year: fin.year, sourceType: fin.source, sourceName: fin.source==='real'?`${fin.year}å¹´æŠ¥`:fin.name,
                    mktCap: mk, rev: fin.rev, prof: fin.prof, 
                    pe: fin.prof>0 ? mk/fin.prof : -1, ps: fin.rev>0 ? mk/fin.rev : 0
                };
            }
            return d;
        });
    }

    function renderChart() {
        if(!globalData.length) return;
        const dates = globalData.map(d => d.date);
        
        splitIdxGlobal = globalData.findIndex(d => d.sourceType === 'manual');
        if(splitIdxGlobal === -1) splitIdxGlobal = globalData.length;

        const peReal = globalData.map((d, i) => (i <= splitIdxGlobal && d.pe > 0) ? d.pe.toFixed(2) : null);
        const pePred = globalData.map((d, i) => (i >= splitIdxGlobal && d.pe > 0) ? d.pe.toFixed(2) : null);
        if(splitIdxGlobal < globalData.length && splitIdxGlobal > 0 && globalData[splitIdxGlobal].pe > 0) pePred[splitIdxGlobal] = globalData[splitIdxGlobal].pe.toFixed(2);

        const psReal = globalData.map((d, i) => (i <= splitIdxGlobal) ? d.ps.toFixed(2) : null);
        const psPred = globalData.map((d, i) => (i >= splitIdxGlobal) ? d.ps.toFixed(2) : null);
        if(splitIdxGlobal < globalData.length && splitIdxGlobal > 0) psPred[splitIdxGlobal] = globalData[splitIdxGlobal].ps.toFixed(2);

        const option = {
            animation: false,
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { data: ['PE', 'PS'], top: 5 },
            grid: { left: '3%', right: '3%', bottom: '15%', top: '15%', containLabel: true },
            dataZoom: [ { type: 'inside', start: 0, end: 100 }, { type: 'slider', bottom: 5, height: 20 } ],
            xAxis: { type: 'category', data: dates, boundaryGap: false },
            yAxis: [
                { type: 'value', name: 'PS', position: 'left', scale: true, axisLine: { show: true, lineStyle: { color: '#007aff' } }, splitLine: { show: false } },
                { type: 'value', name: 'PE', position: 'right', scale: true, axisLine: { show: true, lineStyle: { color: '#ff3b30' } }, splitLine: { lineStyle: { type: 'dashed', color: '#eee' } } }
            ],
            series: [
                { name: 'PS', type: 'line', yAxisIndex: 0, data: psReal, smooth: true, showSymbol: false, lineStyle: { color: '#007aff', width: 2 }, itemStyle: { color: '#007aff' } },
                { name: 'PS', type: 'line', yAxisIndex: 0, data: psPred, smooth: true, showSymbol: false, lineStyle: { color: '#007aff', width: 2, type: 'dashed' }, itemStyle: { color: '#007aff' }, showInLegend: false },
                { name: 'PE', type: 'line', yAxisIndex: 1, data: peReal, smooth: true, showSymbol: false, lineStyle: { color: '#ff3b30', width: 2 }, itemStyle: { color: '#ff3b30' }, connectNulls: true },
                { name: 'PE', type: 'line', yAxisIndex: 1, data: pePred, smooth: true, showSymbol: false, lineStyle: { color: '#ff3b30', width: 2, type: 'dashed' }, itemStyle: { color: '#ff3b30' }, connectNulls: true, showInLegend: false }
            ]
        };
        myChart.setOption(option, true);
        updateDynamicMarks();
    }

    function updateDynamicMarks() {
        if (!myChart || !globalData.length) return;
        const opt = myChart.getOption();
        const start = opt.dataZoom[0].start;
        const end = opt.dataZoom[0].end;
        const len = globalData.length;
        
        const sIdx = Math.floor(len * start / 100);
        const eIdx = Math.ceil(len * end / 100);
        
        const viewData = globalData.slice(sIdx, eIdx);
        if(viewData.length === 0) return;

        let psMaxVal = -Infinity, psMinVal = Infinity, psMaxIdx = -1, psMinIdx = -1;
        let peMaxVal = -Infinity, peMinVal = Infinity, peMaxIdx = -1, peMinIdx = -1;

        viewData.forEach((d, i) => {
            const realIdx = sIdx + i;
            if(d.ps !== null) {
                if(d.ps > psMaxVal) { psMaxVal = d.ps; psMaxIdx = realIdx; }
                if(d.ps < psMinVal) { psMinVal = d.ps; psMinIdx = realIdx; }
            }
            if(d.pe > 0) {
                if(d.pe > peMaxVal) { peMaxVal = d.pe; peMaxIdx = realIdx; }
                if(d.pe < peMinVal) { peMinVal = d.pe; peMinIdx = realIdx; }
            }
        });

        const createMP = (idx, type) => {
            if(idx === -1) return null;
            let seriesIndex = 0;
            if (type === 'PS') seriesIndex = idx <= splitIdxGlobal ? 0 : 1;
            else               seriesIndex = idx <= splitIdxGlobal ? 2 : 3;
            
            return {
                seriesIndex: seriesIndex,
                coord: [idx, type==='PS'?globalData[idx].ps : globalData[idx].pe],
                value: (type==='PS'?globalData[idx].ps:globalData[idx].pe).toFixed(2),
                itemStyle: { color: type==='PS'?'#007aff':'#ff3b30' }
            };
        };

        const mpDataPS = [createMP(psMaxIdx, 'PS'), createMP(psMinIdx, 'PS')].filter(x=>x);
        const mpDataPE = [createMP(peMaxIdx, 'PE'), createMP(peMinIdx, 'PE')].filter(x=>x);

        const mp0 = mpDataPS.filter(d => d.seriesIndex === 0).map(d => ({...d, name: d.coord[1]===psMaxVal?'Max':'Min'}));
        const mp1 = mpDataPS.filter(d => d.seriesIndex === 1).map(d => ({...d, name: d.coord[1]===psMaxVal?'Max':'Min'}));
        const mp2 = mpDataPE.filter(d => d.seriesIndex === 2).map(d => ({...d, name: d.coord[1]===peMaxVal?'Max':'Min'}));
        const mp3 = mpDataPE.filter(d => d.seriesIndex === 3).map(d => ({...d, name: d.coord[1]===peMaxVal?'Max':'Min'}));

        myChart.setOption({
            series: [
                { markPoint: { data: mp0, symbolSize: 35, label: { fontSize: 10 } } },
                { markPoint: { data: mp1, symbolSize: 35, label: { fontSize: 10 } } },
                { markPoint: { data: mp2, symbolSize: 35, label: { fontSize: 10 } } },
                { markPoint: { data: mp3, symbolSize: 35, label: { fontSize: 10 } } }
            ]
        });
    }

    function renderTable() {
        const t = document.querySelector('#dataTable tbody'); t.innerHTML = '';
        [...globalData].reverse().slice(0,300).forEach(d => {
            if(!d.pe) return;
            const cls = d.sourceType==='real'?'tag-real':'tag-man';
            const act = d.sourceType==='manual'?`onclick="editYearData(${d.year})"`:'';
            t.innerHTML += `<tr><td>${d.date}</td><td>${d.price.toFixed(2)}</td>
                <td><span class="tag ${cls}" ${act}>${d.sourceName} ${d.sourceType==='manual'?'âœ':''}</span></td>
                <td>${(d.mktCap/1e8).toFixed(2)}</td><td>${(d.rev/1e8).toFixed(2)}</td><td class="${d.prof>0?'':'loss'}">${(d.prof/1e8).toFixed(2)}</td>
                <td class="val-pe">${d.pe>0?d.pe.toFixed(2):'äº'}</td><td class="val-ps">${d.ps.toFixed(2)}</td></tr>`;
        });
    }

    function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }
    function getLocal() { return JSON.parse(localStorage.getItem(DB_KEY) || "{}"); }
    function getDB(c, y) { let db = getLocal(); return (db[c] && db[c][y]) || null; }

    async function syncCloud() {
        if(!ghConfig.token) return;
        setStatus('sync', 'åŒæ­¥ä¸­');
        try {
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}?t=${Date.now()}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });
            if(res.ok) {
                const d = await res.json();
                const cloud = JSON.parse(b64_to_utf8(d.content));
                localStorage.setItem(DB_KEY, JSON.stringify({...getLocal(), ...cloud}));
                setStatus('ok', 'åœ¨çº¿');
                if(currentStock.code) runAnalysis(true);
            } else if(res.status === 404) setStatus('ok', 'æ–°åº“'); 
            else setStatus('err', 'å¤±è´¥');
        } catch(e) { setStatus('err', 'ç½‘ç»œé”™'); }
    }

    async function saveDB(code, year, rev, prof) {
        let db = getLocal();
        if(!db[code]) db[code] = {};
        db[code][year] = { rev, prof, ts: Date.now() };
        localStorage.setItem(DB_KEY, JSON.stringify(db));

        if(ghConfig.token) {
            clearTimeout(syncTimer);
            syncTimer = setTimeout(async () => {
                setStatus('sync', 'ä¸Šä¼ ');
                try {
                    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;
                    const get = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });
                    let sha = get.ok ? (await get.json()).sha : null;
                    await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `upd ${code}`, content: utf8_to_b64(JSON.stringify(getLocal())), sha })
                    });
                    setStatus('ok', 'å·²ä¿å­˜');
                } catch(e) { setStatus('err', 'ä¸Šä¼ å¤±è´¥'); }
            }, 1000);
        } else toast('ä»…ä¿å­˜æœ¬åœ°');
    }

    async function fetchShares() {
        try {
            const r = await fetch(PROXY + encodeURIComponent(`https://push2.eastmoney.com/api/qt/stock/get?secid=${currentStock.secId}&fields=f84,f20,f2&invt=2`));
            const j = await r.json();
            currentTotalShares = j?.data?.f84 || 1e8;
        } catch(e) { currentTotalShares = 1e8; }
    }
    async function fetchKline(beg, end) {
        const r = await fetch(PROXY + encodeURIComponent(`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${currentStock.secId}&fields1=f1&fields2=f51,f53&klt=101&fqt=1&beg=${beg}&end=${end}`));
        const j = await r.json();
        if(!j?.data?.klines) throw new Error("æ— è‚¡ä»·");
        globalData = j.data.klines.map(k => { const p=k.split(','); return { date: p[0], price: parseFloat(p[1]) }; });
    }
    async function fetchFinancials(code) {
        let map = {};
        try {
            const url = `https://datacenter-web.eastmoney.com/api/data/v1/get?reportName=RPT_LICO_FN_CPD&filter=(SECURITY_CODE="${code}")&columns=ALL&pageSize=500&pageNumber=1`;
            const res = await fetch(PROXY + encodeURIComponent(url));
            const json = await res.json();
            if(json?.result?.data) {
                json.result.data.forEach(i => {
                    if(i.REPORT_DATE && i.REPORT_DATE.includes("-12-31")) {
                        const y = parseInt(i.REPORT_DATE.substring(0,4));
                        const rev = i.TOTAL_OPERATE_INCOME || i.OPERATE_INCOME;
                        const prof = i.PARENT_NETPROFIT || i.NETPROFIT;
                        if(rev && prof) map[y] = { year: y, rev, prof, source: 'real', name: `${y}å¹´æŠ¥` };
                    }
                });
            }
        } catch(e) {}
        return map;
    }

    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    function setStatus(s, t) { document.getElementById('syncDot').className = 'dot ' + s; document.getElementById('syncTxt').innerText = t; }
    
    function openInput(y, r='', p='') {
        return new Promise(res => {
            document.getElementById('modalYear').innerText = y;
            document.getElementById('inRev').value = r;
            document.getElementById('inProf').value = p;
            document.getElementById('inputModal').style.display = 'flex';
            inputResolve = res;
        });
    }
    function closeInput(ok) {
        document.getElementById('inputModal').style.display = 'none';
        if(ok && inputResolve) {
            const r = parseFloat(document.getElementById('inRev').value);
            const p = parseFloat(document.getElementById('inProf').value);
            if(r && p) inputResolve({rev:r*1e8, prof:p*1e8}); else { toast('æ— æ•ˆæ•°å­—'); inputResolve(null); }
        } else if(inputResolve) inputResolve(null);
    }
    async function editYearData(y) {
        const s = getDB(currentStock.code, y);
        const m = await openInput(y, s?s.rev/1e8:'', s?s.prof/1e8:'');
        if(m) { await saveDB(currentStock.code, y, m.rev, m.prof); runAnalysis(true); }
    }

    window.showSettings = () => {
        document.getElementById('settingModal').style.display = 'flex';
        document.getElementById('cfgToken').value = ghConfig.token;
        document.getElementById('cfgUser').value = ghConfig.user;
        document.getElementById('cfgRepo').value = ghConfig.repo;
    };
    window.closeSettings = () => document.getElementById('settingModal').style.display = 'none';
    window.saveConfig = () => {
        ghConfig.token = document.getElementById('cfgToken').value;
        ghConfig.user = document.getElementById('cfgUser').value;
        ghConfig.repo = document.getElementById('cfgRepo').value;
        localStorage.setItem('gh_token', ghConfig.token);
        localStorage.setItem('gh_user', ghConfig.user);
        localStorage.setItem('gh_repo', ghConfig.repo);
        closeSettings(); syncCloud();
    };
    window.resetZoom = () => myChart.dispatchAction({ type: 'dataZoom', start: 0, end: 100 });
</script>
</body>
</html>
